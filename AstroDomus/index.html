<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Traditional Astrology Chart</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <div class="chart-section">
            <div class="controls">
                <button id="zodiacBtn" class="active" onclick="setMode('zodiac')">Zodiac</button>
                <button id="housesBtn" onclick="setMode('houses')">Houses</button>
                <button id="planetsBtn" onclick="setMode('planets')">Planets</button>
                <button id="drawBtn" onclick="setMode('draw')">Draw</button>
                <button onclick="resetChart()">Reset</button>
                <select id="planetSelect" style="display:none;">
                    <option value="">Add Planet...</option>
                    <option value="☉">☉ Sun</option><option value="☽">☽ Moon</option><option value="☿">☿ Mercury</option>
                    <option value="♀">♀ Venus</option><option value="♂">♂ Mars</option><option value="♃">♃ Jupiter</option>
                    <option value="♄">♄ Saturn</option><option value="☊">☊ North Node</option><option value="☋">☋ South Node</option>
                    <option value="⦻">⦻ Part of Fortune</option>
                </select>
            </div>
            <div class="draw-controls" id="drawControls" style="display:none;">
                <label>Tool: 
                    <select id="drawTool">
                        <option value="pencil">Pencil</option>
                        <option value="line">Line</option>
                        <option value="eraser">Eraser</option>
                    </select>
                </label>
                <label>Color: <input type="color" id="drawColor" value="#FF6666"></label>
                <label>Size: <input type="range" id="drawSize" min="1" max="10" value="2"></label>
                <span id="sizeValue">2px</span>
                <button onclick="clearDrawing()">Clear Drawing</button>
            </div>
            <div class="controls">
                <label><input type="checkbox" id="showInfo"> Details</label>
                <label><input type="checkbox" id="showDignities"> Dignities</label>
                <label><input type="checkbox" id="showQualities"> Qualities</label>
                <label><input type="checkbox" id="showElements"> Elements</label>
                <label><input type="checkbox" id="showSeason"> Seasons</label>
                <label><input type="checkbox" id="showSolarIngress"> Solar Ingress Dates</label>
                <label><input type="checkbox" id="showFigureSigns"> Figures of the Signs</label>
                <label><input type="checkbox" id="showFertileBarren"> Fertile and Barren Signs</label>
                <label><input type="checkbox" id="showSignTemps"> Sign Temps</label>
                <label><input type="checkbox" id="showSignGenders"> Sign Gender</label>
                <label><input type="checkbox" id="showAngles"> Angles (ASC/DSC/MC/IC)</label>
            </div>
            <div class="controls">
                <label><input type="checkbox" id="showPlanetTemps"> Planet Temps</label>
                <label><input type="checkbox" id="showPlanetSect"> Planet Sect</label>
                <label><input type="checkbox" id="showBeneficMaleficPlanets"> Benefic planets / Malefic planets</label>
                <label><input type="checkbox" id="showPlanetGender"> Planet Gender</label>
                <label><input type="checkbox" id="showHouseSect"> House Sect</label>
                <label><input type="checkbox" id="showHouseTypes"> House Types</label>
                <label><input type="checkbox" id="showhouseJoy"> House Joy</label>
                <label><input type="checkbox" id="showEgyptianBounds"> Egyptian Bounds</label>
                <label><input type="checkbox" id="showPtolemyBounds"> Ptolemy Bounds</label>
                <label><input type="checkbox" id="showChaldeanBounds"> Chaldean Bounds</label>
                <label><input type="checkbox" id="showDecans"> Decans</label>
                <label><input type="checkbox" id="showDirections"> House Directions</label>
            </div>
            <div id="info">Select mode to interact with chart</div>
            <canvas id="chart" width="800" height="800"></canvas>
            <div class="eraser-indicator" id="eraserIndicator"></div>
        </div>
        <div class="keywords-section">
            <div class="keywords" id="keywordsPanel">
                <h3>Traditional Astrology Keywords</h3>
                <p>Click on any planet, zodiac sign, or house to see traditional keywords and meanings.</p>
            </div>
        </div>
    </div>

    <script>
// Professional Astrology Chart Engine - Refactored & Optimized
const AstrologyChart = (() => {
    // Core Configuration
    const CONFIG = {
        canvas: document.getElementById('chart'),
        ctx: document.getElementById('chart').getContext('2d'),
        center: 400,
        radii: {outer: 320, egyptian: 295, ptolemy: 270, chaldean: 245, decan: 220, inner: 195, aspect: 80},
        colors: {bg: '#0a0a0a', ring: '#333', text: '#fff', accent: '#FFD700', selected: '#FF6666', dim: '#666'}
    };

    // Application State
    let state = {
        mode: 'zodiac', isDragging: false, dragTarget: null, zodiacOffset: 0, lastZodiacAngle: 0,
        isDrawing: false, isErasing: false, drawingPaths: [], currentPath: [], lineStartPoint: null,
        selectedSign: null, selectedPlanet: null, ascendantOffset: 0, dragAngleControl: null
    };

    // Astrology Data Repository
    const ASTRO_DATA = {
        signs: ['♈','♉','♊','♋','♌','♍','♎','♏','♐','♑','♒','♓'],
        signNames: ['Aries','Taurus','Gemini','Cancer','Leo','Virgo','Libra','Scorpio','Sagittarius','Capricorn','Aquarius','Pisces'],
        seasons: ['Spring - Hot and Moist','Spring - Hot and Moist','Spring - Hot and Moist','Summer - Hot and Dry','Summer - Hot and Dry','Summer - Hot and Dry','Autumn - Cold and Dry','Autumn - Cold and Dry','Autumn - Cold and Dry','Winter - Cold and Moist','Winter - Cold and Moist','Winter - Cold and Moist'],
        qualities: ['Cardinal','Fixed','Mutable','Cardinal','Fixed','Mutable','Cardinal','Fixed','Mutable','Cardinal','Fixed','Mutable'],
        houseNames: ['1st House (Self) - Temple of Mercury','2nd House (Money) - Typhons dwelling','3rd House (Siblings) - Temple of the Moon','4th House (Home) - Temple of Saturn','5th House (Children)','6th House (Health)','7th House (Marriage)','8th House (Death) Typhons dwelling','9th House (Religion) - Temple of the Sun','10th House (Career) - Temple of Venus','11th House (Friends) - Temple of Jupiter','12th House (Hidden)'],
        decans: [['♂','☉','♀'],['☿','☽','♄'],['♃','♂','☉'],['♀','☿','☽'],['♄','♃','♂'],['☉','♀','☿'],['☽','♄','♃'],['♂','☉','♀'],['☿','☽','♄'],['♃','♂','☉'],['♀','☿','☽'],['♄','♃','♂']],
        solarIngress: ['Mar 21 - Apr 19','Apr 20 - May 20','May 21 - Jun 20','Jun 21 - Jul 22','Jul 23 - Aug 22','Aug 23 - Sep 22','Sep 23 - Oct 22','Oct 23 - Nov 21','Nov 22 - Dec 21','Dec 22 - Jan 19','Jan 20 - Feb 18','Feb 19 - Mar 20'],
        figureSigns: ['Bestial','Bestial','Human','Aquatic','Bestial','Human','Human','Aquatic','Half-Beast Half-Human','Half-Beast Half-Human','Human','Aquatic'],
        fertileBarren: ['Moderately Barren','Moderately Fertile','Fertile','Fertile','Barren','Barren','Moderately Fertile','Fertile','Moderately Fertile','Moderately Barren','Moderately Barren','Fertile'],
        elements: ['Fire','Earth','Air','Water','Fire','Earth','Air','Water','Fire','Earth','Air','Water'],
        signTemps: ['Choleric','Melancholic','Sanguine','Phlegmatic','Choleric','Melancholic','Sanguine','Phlegmatic','Choleric','Melancholic','Sanguine','Phlegmatic'],
        signGenders: ['Male','Female','Male','Female','Male','Female','Male','Female','Male','Female','Male','Female'],
        houseDirections: ['East','East-Northeast','Northeast','North','North-Northwest','Northwest','West','West-Southwest','Southwest','South','South-Southeast','Southeast'],
        planetTemps: {'☉':'Choleric','☽':'Phlegmatic','☿':'V','♀':'Sanguine/Phlegmatic','♂':'Choleric','♃':'Sanguine','♄':'Melancholic','☊':'V','☋':'V','⦻':'V'},
        planetSect: {'☉':'Diurnal','☽':'Nocturnal ','☿':'C','♀':'Nocturnal','♂':'Diurnal','♃':'Diurnal','♄':'Diurnal','☊':'Nocturnal','☋':'Diurnal','⦻':'C'},
        beneficMaleficPlanets: {'☉':'','☽':'','☿':'','♀':'Benefic','♂':'Malefic','♃':'Benefic','♄':'Malefic','☊':'','☋':'','⦻':'C'},
        planetGender: {'☉':'Male','☽':'Female','☿':'N','♀':'Female','♂':'Male','♃':'Male','♄':'Male','☊':'N','☋':'N','⦻':'N'},
        houseSect: ['Nocturnal','Nocturnal','Nocturnal','Nocturnal','Nocturnal','Nocturnal','Diurnal','Diurnal','Diurnal','Diurnal','Diurnal','Diurnal'],
        houseTypes: ['Angular','Succedent','Cadent','Angular','Succedent','Cadent','Angular','Succedent','Cadent','Angular','Succedent','Cadent'],
        houseJoy: ['Joy ☿ (Mercury)','','Joy ☽ (Moon)','','Joy ♀ (Venus)','Joy ♂ (Mars)','','','Joy ☉ (Sun)','','Joy ♃ (Jupiter)','Joy ♄ (Saturn)'],
        rulers: {0:'♂',1:'♀',2:'☿',3:'☽',4:'☉',5:'☿',6:'♀',7:'♂',8:'♃',9:'♄',10:'♄',11:'♃'},
        exaltations: {0:'☉',1:'☽',2:'☊',5:'☿',6:'♄',8:'☋',9:'♂',11:'♀'},
        detriments: {0:'♀',1:'♂',2:'♃',3:'♄',4:'♄',5:'♃',6:'♂',7:'♀',8:'☿',9:'☽',10:'☉',11:'☿'},
        falls: {2:'☋',5:'♀',6:'☉',8:'☊',9:'☽',11:'☿'},
        egyptianBounds: [[['♃',6],['♀',12],['☿',20],['♂',25],['♄',30]],[['♀',8],['☿',14],['♃',22],['♄',27],['♂',30]],[['☿',6],['♃',12],['♀',17],['♂',24],['♄',30]],[['♂',7],['♀',13],['☿',19],['♃',26],['♄',30]],[['♃',6],['♀',11],['♄',18],['☿',24],['♂',30]],[['☿',7],['♀',17],['♃',21],['♂',28],['♄',30]],[['♄',6],['☿',14],['♃',21],['♀',28],['♂',30]],[['♂',7],['♀',11],['☿',19],['♃',24],['♄',30]],[['♃',12],['♀',17],['☿',21],['♄',26],['♂',30]],[['♀',6],['☿',12],['♃',19],['♂',25],['♄',30]],[['♄',6],['☿',12],['♀',20],['♃',25],['♂',30]],[['♀',12],['♃',16],['☿',19],['♂',28],['♄',30]]],
        ptolemyBounds: [[['♃',6],['♀',14],['☿',21],['♂',26],['♄',30]],[['♀',8],['☿',15],['♃',22],['♄',26],['♂',30]],[['☿',7],['♃',14],['♀',21],['♄',25],['♂',30]],[['♂',6],['♃',13],['☿',20],['♀',27],['♄',30]],[['♃',6],['♀',13],['♄',19],['☿',25],['♂',30]],[['☿',7],['♀',13],['♃',18],['♄',24],['♂',30]],[['♄',6],['♀',11],['♃',19],['☿',24],['♂',30]],[['♂',6],['♃',14],['♀',21],['☿',27],['♄',30]],[['♃',8],['♀',14],['☿',19],['♄',25],['♂',30]],[['♀',6],['☿',12],['♃',19],['♂',25],['♄',30]],[['☿',7],['♀',13],['♃',20],['♂',25],['♄',30]],[['♀',8],['♃',14],['☿',20],['♂',26],['♄',30]]],
        chaldeanBounds: [[['♂',6],['☉',12],['♀',20],['☿',25],['♄',30]],[['♀',8],['☿',15],['☽',22],['♄',26],['♂',30]],[['☿',6],['♃',13],['♀',17],['♄',24],['♂',30]],[['♂',6],['♀',12],['☽',18],['♃',24],['♄',30]],[['♄',6],['☿',13],['♀',19],['♃',25],['♂',30]],[['☿',6],['♀',12],['♃',18],['♄',24],['♂',30]],[['♄',6],['♀',11],['♃',16],['☿',24],['♂',30]],[['♂',6],['♀',14],['☿',21],['♃',27],['♄',30]],[['♃',8],['♀',13],['☿',18],['♄',26],['♂',30]],[['♀',6],['☿',11],['♃',16],['♂',23],['♄',30]],[['☿',6],['♀',12],['♃',20],['♂',24],['♄',30]],[['♀',8],['♃',13],['☿',17],['♂',23],['♄',30]]]
    };

    let planets = [{symbol:'☉',name:'Sun',angle:120,color:'#FFD700'},{symbol:'☽',name:'Moon',angle:90,color:'#C0C0C0'},{symbol:'♂',name:'Mars',angle:0,color:'#FF4500'},{symbol:'♀',name:'Venus',angle:30,color:'#32CD32'},{symbol:'☿',name:'Mercury',angle:60,color:'#FFA500'},{symbol:'♃',name:'Jupiter',angle:240,color:'#4169E1'},{symbol:'♄',name:'Saturn',angle:270,color:'#8B4513'}];

    const keywords = {signs:{'Aries':['Cardinal Fire','Hot & Dry','Choleric','Masculine','Diurnal','Spring Equinox','Ram','Head & Face','Initiative','Commanding','Mars Domicile','Sun Exaltation','Eastern','Moveable','Bestial'],'Taurus':['Fixed Earth','Cold & Dry','Melancholic','Feminine','Nocturnal','Spring','Bull','Neck & Throat','Stability','Possessions','Venus Domicile','Moon Exaltation','Southern','Solid','Four-footed'],'Gemini':['Mutable Air','Hot & Moist','Sanguine','Masculine','Diurnal','Late Spring','Twins','Arms & Hands','Communication','Versatility','Mercury Domicile','North Node Exalt','Western','Bicorporeal','Human'],'Cancer':['Cardinal Water','Cold & Moist','Phlegmatic','Feminine','Nocturnal','Summer Solstice','Crab','Breast & Stomach','Home','Mother','Moon Domicile','Jupiter Traditional','Northern','Tropical','Mute'],'Leo':['Fixed Fire','Hot & Dry','Choleric','Masculine','Diurnal','Midsummer','Lion','Heart & Back','Royalty','Authority','Sun Domicile','No Exaltation','Eastern','Commanding','Bestial'],'Virgo':['Mutable Earth','Cold & Dry','Melancholic','Feminine','Nocturnal','Late Summer','Virgin','Belly & Intestines','Service','Analysis','Mercury Domicile','Mercury Exaltation','Southern','Barren','Human'],'Libra':['Cardinal Air','Hot & Moist','Sanguine','Masculine','Diurnal','Autumn Equinox','Scales','Kidneys & Lumbar','Balance','Justice','Venus Domicile','Saturn Exaltation','Western','Moveable','Human'],'Scorpio':['Fixed Water','Cold & Moist','Phlegmatic','Feminine','Nocturnal','Autumn','Scorpion','Genitals','Death','Transformation','Mars Domicile','South Node Exalt','Northern','Fruitful','Reptile'],'Sagittarius':['Mutable Fire','Hot & Dry','Choleric','Masculine','Diurnal','Late Autumn','Centaur','Thighs & Hips','Philosophy','Religion','Jupiter Domicile','No Exaltation','Eastern','Bicorporeal','Four-footed'],'Capricorn':['Cardinal Earth','Cold & Dry','Melancholic','Feminine','Nocturnal','Winter Solstice','Goat','Knees','Authority','Structure','Saturn Domicile','Mars Exaltation','Southern','Tropical','Four-footed'],'Aquarius':['Fixed Air','Hot & Moist','Sanguine','Masculine','Diurnal','Midwinter','Water-bearer','Calves & Ankles','Friendship','Groups','Saturn Domicile','No Exaltation','Western','Human','Rational'],'Pisces':['Mutable Water','Cold & Moist','Phlegmatic','Feminine','Nocturnal','Late Winter','Fishes','Feet','Compassion','Sacrifice','Jupiter Domicile','Venus Exaltation','Northern','Bicorporeal','Mute']},planets:{'Sun':['Greater Luminary','Hot & Dry','Choleric','Masculine','Gold','Leo Ruler','Aries Exalted','Father','King','Authority','Vitality','Honor','Government','Right Eye','Spirit'],'Moon':['Lesser Luminary','Cold & Moist','Phlegmatic','Feminine','Silver','Cancer Ruler','Taurus Exalted','Mother','Queen','Body','Fluctuation','Memory','Common People','Left Eye','Soul'],'Mercury':['Neutral Planet','Convertible','Convertible','Neutral','Quicksilver','Gemini/Virgo Ruler','Virgo Exalted','Messenger','Youth','Learning','Speech','Commerce','Writing','Siblings','Swift'],'Venus':['Lesser Benefic','Cold & Moist','Phlegmatic','Feminine','Copper','Taurus/Libra Ruler','Pisces Exalted','Love','Beauty','Pleasure','Women','Art','Music','Marriage','Harmony'],'Mars':['Lesser Malefic','Hot & Dry','Choleric','Masculine','Iron','Aries/Scorpio Ruler','Capricorn Exalted','War','Strife','Courage','Surgery','Iron','Soldiers','Cutting','Violence'],'Jupiter':['Greater Benefic','Hot & Moist','Sanguine','Masculine','Tin','Sagittarius/Pisces Ruler','Cancer Traditional','Wisdom','Religion','Fortune','Expansion','Law','Philosophy','Priests','Judges'],'Saturn':['Greater Malefic','Cold & Dry','Melancholic','Masculine','Lead','Capricorn/Aquarius Ruler','Libra Exalted','Time','Limitation','Discipline','Old Age','Hardship','Agriculture','Patience','Wisdom']},houses:{'1st':['Angular House','House of Life','Ascendant','Self','Body','Appearance','Vitality','Character','Native','Health','Temperament','Life Force','Beginning of Life','Personal Manner','Constitution'],'2nd':['Succedent House','Gate of Hades','Possessions','Moveable Goods','Money','Substance','Profit','Gain','Resources','Food','Clothing','Personal Property','Wealth','Material Security','Earnings'],'3rd':['Cadent House','House of Goddess','Siblings','Brethren','Short Journeys','Letters','Messages','Moon Joy','Neighbors','Reports','Communications','Local Travel','Religious Worship','Small Travels','Announcements'],'4th':['Angular House','Angle of Earth','Father','Parents','Ancestry','Land','Real Estate','End of Life','Grave','Hidden Treasure','Foundations','Inheritance from Father','Old Age','Private Affairs','Homeland'],'5th':['Succedent House','House of Good Fortune','Children','Offspring','Pregnancy','Venus Joy','Pleasure','Entertainment','Good Fortune','Gifts','Legacies','Recreation','Creative Works','Procreation','Joy'],'6th':['Cadent House','House of Bad Fortune','Illness','Sickness','Servants','Slaves','Small Animals','Mars Joy','Enemies','Work','Service','Bad Fortune','Injury','Laborers','Misfortune'],'7th':['Angular House','Angle of West','Marriage','Spouse','Partnerships','Open Enemies','Others','Legal Opponents','Contracts','War','Lawsuits','Public Relations','Competitors','Thieves','Fugitives'],'8th':['Succedent House','House of Death','Death','Wills','Legacies','Others Money','Saturn Joy','Inheritance','Debt','Taxes','Partners Resources','Fear','Anxiety','Transformation','Occult Sciences'],'9th':['Cadent House','House of God','Religion','Philosophy','Long Journeys','Foreign Lands','Sun Joy','Dreams','Visions','Higher Learning','Prophecy','Wisdom','Spiritual Matters','Foreign Affairs','Publishing'],'10th':['Angular House','House of Honor','Midheaven','Mother','Career','Reputation','Honor','Authority','Government','Fame','Public Standing','Achievement','Kingdom','Dignity','Social Position'],'11th':['Succedent House','House of Good Spirit','Friends','Hope','Good Fortune','Jupiter Joy','Benefactors','Allies','Good Daemon','Counselors','Trust','Praise','Acquisition','Assistants','Social Groups'],'12th':['Cadent House','House of Bad Spirit','Hidden Enemies','Secret Foes','Large Animals','Imprisonment','Exile','Sorrow','Self-Undoing','Bad Spirit','Affliction','Witchcraft','Secret Sorrows','Private Enemies','Confinement']}};

    // Math Utilities
    const Utils = {
        degToRad: deg => deg * Math.PI / 180,
        radToDeg: rad => rad * 180 / Math.PI,
        getPlanetPos: angle => {const astroAngle = 180 - angle, rad = Utils.degToRad(astroAngle), r = (CONFIG.radii.inner + CONFIG.radii.outer) / 2; return {x: CONFIG.center + Math.cos(rad) * r, y: CONFIG.center + Math.sin(rad) * r};},
        getAngleFromPos: (x, y) => {const dx = x - CONFIG.center, dy = y - CONFIG.center, angle = 180 - Utils.radToDeg(Math.atan2(dy, dx)); return ((angle % 360) + 360) % 360;},
        getSignFromAngle: angle => Math.floor(((angle - state.zodiacOffset + 360) % 360) / 30),
        getHouseFromAngle: angle => Math.floor(((angle + 360) % 360) / 30),
        getDignity: (planetSymbol, signIndex) => {if(ASTRO_DATA.rulers[signIndex] === planetSymbol) return 'Domicile'; if(ASTRO_DATA.exaltations[signIndex] === planetSymbol) return 'Exaltation'; if(ASTRO_DATA.detriments[signIndex] === planetSymbol) return 'Detriment'; if(ASTRO_DATA.falls[signIndex] === planetSymbol) return 'Fall'; return 'Peregrine';},
        getDignityColor: dignity => ({Domicile:'#00FF00',Exaltation:'#FFD700',Detriment:'#FF6666',Fall:'#FF4444',Peregrine:'#CCCCCC'})[dignity],
        getMousePos: e => {const rect = CONFIG.canvas.getBoundingClientRect(); return {x: e.clientX - rect.left, y: e.clientY - rect.top};}
    };

    // Hit Detection System
    const HitDetection = {
        getPlanetAt: (x, y) => {for(let i = planets.length - 1; i >= 0; i--) {const pos = Utils.getPlanetPos(planets[i].angle), distance = Math.sqrt((x - pos.x) ** 2 + (y - pos.y) ** 2); if(distance < 25) return {planet: planets[i], index: i};} return null;},
        getSignAt: (x, y) => {const distance = Math.sqrt((x - CONFIG.center) ** 2 + (y - CONFIG.center) ** 2); return (distance >= CONFIG.radii.decan && distance <= CONFIG.radii.outer) ? Utils.getSignFromAngle(Utils.getAngleFromPos(x, y)) : null;},
        getHouseAt: (x, y) => {const distance = Math.sqrt((x - CONFIG.center) ** 2 + (y - CONFIG.center) ** 2); return distance <= CONFIG.radii.inner ? Utils.getHouseFromAngle(Utils.getAngleFromPos(x, y)) : null;},
        isInZodiacRing: (x, y) => {const distance = Math.sqrt((x - CONFIG.center) ** 2 + (y - CONFIG.center) ** 2); return distance >= CONFIG.radii.decan && distance <= CONFIG.radii.outer;},
        getAngleControlAt: (x, y) => {if(!document.getElementById('showAngles').checked) return null; const controls = Renderer.getAngleControlPoints(); for(const [name, pos] of Object.entries(controls)) {const distance = Math.sqrt((x - pos.x) ** 2 + (y - pos.y) ** 2); if(distance < 12) return name;} return null;}
    };

    // Drawing System
    const DrawingSystem = {
        getDistanceToLine: (px, py, x1, y1, x2, y2) => {const A = px - x1, B = py - y1, C = x2 - x1, D = y2 - y1, dot = A * C + B * D, lenSq = C * C + D * D; if(lenSq === 0) return Math.sqrt(A * A + B * B); const param = Math.max(0, Math.min(1, dot / lenSq)), xx = x1 + param * C, yy = y1 + param * D; return Math.sqrt((px - xx) ** 2 + (py - yy) ** 2);},
        eraseAtPoint: (x, y, eraserSize) => {const eraserRadius = eraserSize, pathsToRemove = [], newPathsToAdd = []; state.drawingPaths.forEach((path, pathIndex) => {if(path[0]?.type === 'line') {if(path.length >= 2 && DrawingSystem.getDistanceToLine(x, y, path[0].x, path[0].y, path[path.length - 1].x, path[path.length - 1].y) <= eraserRadius / 2) pathsToRemove.push(pathIndex);} else {const segments = []; let currentSegment = []; path.forEach(point => {const distance = Math.sqrt((x - point.x) ** 2 + (y - point.y) ** 2); if(distance > eraserRadius) currentSegment.push(point); else {if(currentSegment.length > 1) segments.push([...currentSegment]); currentSegment = [];}}); if(currentSegment.length > 1) segments.push(currentSegment); if(segments.length === 0) pathsToRemove.push(pathIndex); else if(segments.length > 1 || segments[0].length !== path.length) {pathsToRemove.push(pathIndex); newPathsToAdd.push(...segments);}}}); pathsToRemove.reverse().forEach(index => state.drawingPaths.splice(index, 1)); state.drawingPaths.push(...newPathsToAdd);},
        drawPaths: () => {state.drawingPaths.forEach(path => {if(path.length < 2) return; CONFIG.ctx.strokeStyle = path[0].color; CONFIG.ctx.lineWidth = path[0].size; CONFIG.ctx.lineCap = 'round'; CONFIG.ctx.lineJoin = 'round'; CONFIG.ctx.beginPath(); if(path[0].type === 'line') {CONFIG.ctx.moveTo(path[0].x, path[0].y); CONFIG.ctx.lineTo(path[path.length - 1].x, path[path.length - 1].y);} else {CONFIG.ctx.moveTo(path[0].x, path[0].y); for(let i = 1; i < path.length; i++) CONFIG.ctx.lineTo(path[i].x, path[i].y);} CONFIG.ctx.stroke();});},
        updateEraserIndicator: (x, y) => {const indicator = document.getElementById('eraserIndicator'), tool = document.getElementById('drawTool').value, eraserSize = parseInt(document.getElementById('drawSize').value); if(tool === 'eraser' && state.mode === 'draw') {const rect = CONFIG.canvas.getBoundingClientRect(), canvasX = rect.left + window.scrollX, canvasY = rect.top + window.scrollY; Object.assign(indicator.style, {left: (canvasX + x - eraserSize * 2) + 'px', top: (canvasY + y - eraserSize * 2) + 'px', width: (eraserSize * 4) + 'px', height: (eraserSize * 4) + 'px', display: 'block'});} else indicator.style.display = 'none';}
    };

    // Professional Rendering Engine (Bounds)
    const Renderer = {
        getAngleControlPoints: () => {const ascAngle = Utils.degToRad(180 - state.ascendantOffset), mcAngle = Utils.degToRad(180 - state.ascendantOffset - 270), controlRadius = CONFIG.radii.outer + 15; return {asc: {x: CONFIG.center + Math.cos(ascAngle) * controlRadius, y: CONFIG.center + Math.sin(ascAngle) * controlRadius}, dsc: {x: CONFIG.center - Math.cos(ascAngle) * controlRadius, y: CONFIG.center - Math.sin(ascAngle) * controlRadius}, mc: {x: CONFIG.center + Math.cos(mcAngle) * controlRadius, y: CONFIG.center + Math.sin(mcAngle) * controlRadius}, ic: {x: CONFIG.center - Math.cos(mcAngle) * controlRadius, y: CONFIG.center - Math.sin(mcAngle) * controlRadius}};},
        drawBoundsSystem: (boundsData, outerRadius, innerRadius, systemName, color) => {for(let i = 0; i < 12; i++) {const bounds = boundsData[i]; let prevDegree = 0; bounds.forEach(([planet, degree]) => {const startAngle = Utils.degToRad(180 - (i * 30 + prevDegree) - state.zodiacOffset), endAngle = Utils.degToRad(180 - (i * 30 + degree) - state.zodiacOffset); CONFIG.ctx.strokeStyle = color; CONFIG.ctx.lineWidth = 1; CONFIG.ctx.beginPath(); CONFIG.ctx.arc(CONFIG.center, CONFIG.center, outerRadius, startAngle, endAngle); CONFIG.ctx.stroke(); CONFIG.ctx.beginPath(); CONFIG.ctx.moveTo(CONFIG.center + Math.cos(endAngle) * innerRadius, CONFIG.center + Math.sin(endAngle) * innerRadius); CONFIG.ctx.lineTo(CONFIG.center + Math.cos(endAngle) * outerRadius, CONFIG.center + Math.sin(endAngle) * outerRadius); CONFIG.ctx.stroke(); const midAngle = (startAngle + endAngle) / 2, textRadius = (outerRadius + innerRadius) / 2, x = CONFIG.center + Math.cos(midAngle) * textRadius, y = CONFIG.center + Math.sin(midAngle) * textRadius; CONFIG.ctx.fillStyle = color; CONFIG.ctx.font = 'bold 25px Arial'; CONFIG.ctx.textAlign = 'center'; CONFIG.ctx.textBaseline = 'middle'; CONFIG.ctx.fillText(planet, x, y); prevDegree = degree;});}},
        drawChart: () => {
            CONFIG.ctx.clearRect(0, 0, CONFIG.canvas.width, CONFIG.canvas.height);
            
            CONFIG.ctx.strokeStyle = '#555'; CONFIG.ctx.lineWidth = 2; [CONFIG.radii.outer, CONFIG.radii.decan, CONFIG.radii.inner].forEach(r => {CONFIG.ctx.beginPath(); CONFIG.ctx.arc(CONFIG.center, CONFIG.center, r, 0, Math.PI * 2); CONFIG.ctx.stroke();}); CONFIG.ctx.strokeStyle = '#444'; CONFIG.ctx.lineWidth = 1; CONFIG.ctx.beginPath(); CONFIG.ctx.arc(CONFIG.center, CONFIG.center, CONFIG.radii.aspect, 0, Math.PI * 2); CONFIG.ctx.stroke();
            
            if(document.getElementById('showEgyptianBounds').checked) {CONFIG.ctx.strokeStyle = CONFIG.colors.dim; CONFIG.ctx.lineWidth = 1; CONFIG.ctx.beginPath(); CONFIG.ctx.arc(CONFIG.center, CONFIG.center, CONFIG.radii.egyptian, 0, Math.PI * 2); CONFIG.ctx.stroke(); Renderer.drawBoundsSystem(ASTRO_DATA.egyptianBounds, CONFIG.radii.outer, CONFIG.radii.egyptian, 'Egyptian', '#8B4513');}
            if(document.getElementById('showPtolemyBounds').checked) {CONFIG.ctx.strokeStyle = CONFIG.colors.dim; CONFIG.ctx.lineWidth = 1; CONFIG.ctx.beginPath(); CONFIG.ctx.arc(CONFIG.center, CONFIG.center, CONFIG.radii.ptolemy, 0, Math.PI * 2); CONFIG.ctx.stroke(); Renderer.drawBoundsSystem(ASTRO_DATA.ptolemyBounds, CONFIG.radii.egyptian, CONFIG.radii.ptolemy, 'Ptolemy', '#4682B4');}
            if(document.getElementById('showChaldeanBounds').checked) {CONFIG.ctx.strokeStyle = CONFIG.colors.dim; CONFIG.ctx.lineWidth = 1; CONFIG.ctx.beginPath(); CONFIG.ctx.arc(CONFIG.center, CONFIG.center, CONFIG.radii.chaldean, 0, Math.PI * 2); CONFIG.ctx.stroke(); Renderer.drawBoundsSystem(ASTRO_DATA.chaldeanBounds, CONFIG.radii.ptolemy, CONFIG.radii.chaldean, 'Chaldean', '#6A5ACD');}
            
            if(document.getElementById('showAngles').checked) {const ascAngle = Utils.degToRad(180 - state.ascendantOffset), mcAngle = Utils.degToRad(180 - state.ascendantOffset - 270), controls = Renderer.getAngleControlPoints(); CONFIG.ctx.strokeStyle = '#FFD700'; CONFIG.ctx.lineWidth = 3; CONFIG.ctx.beginPath(); CONFIG.ctx.moveTo(controls.asc.x, controls.asc.y); CONFIG.ctx.lineTo(controls.dsc.x, controls.dsc.y); CONFIG.ctx.stroke(); CONFIG.ctx.beginPath(); CONFIG.ctx.moveTo(controls.mc.x, controls.mc.y); CONFIG.ctx.lineTo(controls.ic.x, controls.ic.y); CONFIG.ctx.stroke(); CONFIG.ctx.fillStyle = '#FFD700'; CONFIG.ctx.strokeStyle = '#FFD700'; CONFIG.ctx.lineWidth = 2; Object.values(controls).forEach(control => {CONFIG.ctx.beginPath(); CONFIG.ctx.arc(control.x, control.y, 8, 0, Math.PI * 2); CONFIG.ctx.fill(); CONFIG.ctx.stroke();}); const ascSignIndex = Utils.getSignFromAngle(state.ascendantOffset), ascDegree = Math.floor((state.ascendantOffset - state.zodiacOffset + 360) % 30), dscSignIndex = Utils.getSignFromAngle((state.ascendantOffset + 180) % 360), dscDegree = Math.floor(((state.ascendantOffset + 180) - state.zodiacOffset + 360) % 30), mcSignIndex = Utils.getSignFromAngle((state.ascendantOffset + 270) % 360), mcDegree = Math.floor(((state.ascendantOffset + 270) - state.zodiacOffset + 360) % 30), icSignIndex = Utils.getSignFromAngle((state.ascendantOffset + 90) % 360), icDegree = Math.floor(((state.ascendantOffset + 90) - state.zodiacOffset + 360) % 30); CONFIG.ctx.fillStyle = '#FFD700'; CONFIG.ctx.font = 'bold 12px Arial'; CONFIG.ctx.textAlign = 'center'; CONFIG.ctx.textBaseline = 'middle'; const labelOffset = 30; CONFIG.ctx.fillText(`ASC - (East) ${ASTRO_DATA.signNames[ascSignIndex]} ${ascDegree}°`, controls.asc.x, controls.asc.y + labelOffset); CONFIG.ctx.fillText(`DSC - (West) ${ASTRO_DATA.signNames[dscSignIndex]} ${dscDegree}°`, controls.dsc.x, controls.dsc.y + labelOffset); CONFIG.ctx.fillText(`MC - (South) ${ASTRO_DATA.signNames[mcSignIndex]} ${mcDegree}°`, controls.mc.x, controls.mc.y - labelOffset); CONFIG.ctx.fillText(`IC - (North) ${ASTRO_DATA.signNames[icSignIndex]} ${icDegree}°`, controls.ic.x, controls.ic.y - labelOffset);}
            
            for(let i = 0; i < 12; i++) {const startAngle = Utils.degToRad(180 - (i * 30) - state.zodiacOffset), midAngle = Utils.degToRad(180 - (i * 30 + 15) - state.zodiacOffset), isSelected = state.selectedSign === i; CONFIG.ctx.strokeStyle = state.mode === 'zodiac' ? (isSelected ? '#FF6666' : '#888') : '#444'; CONFIG.ctx.lineWidth = state.mode === 'zodiac' ? (isSelected ? 3 : 2) : 1; CONFIG.ctx.beginPath(); CONFIG.ctx.moveTo(CONFIG.center + Math.cos(startAngle) * CONFIG.radii.decan, CONFIG.center + Math.sin(startAngle) * CONFIG.radii.decan); CONFIG.ctx.lineTo(CONFIG.center + Math.cos(startAngle) * CONFIG.radii.outer, CONFIG.center + Math.sin(startAngle) * CONFIG.radii.outer); CONFIG.ctx.stroke(); const signR = (CONFIG.radii.decan + CONFIG.radii.outer) / 2, x = CONFIG.center + Math.cos(midAngle) * signR, y = CONFIG.center + Math.sin(midAngle) * signR; CONFIG.ctx.fillStyle = isSelected ? '#FF6666' : '#FFD700'; CONFIG.ctx.font = 'bold 28px Arial'; CONFIG.ctx.textAlign = 'center'; CONFIG.ctx.textBaseline = 'middle'; CONFIG.ctx.fillText(ASTRO_DATA.signs[i], x, y); let yOffset = 20; if(document.getElementById('showDignities').checked) {CONFIG.ctx.font = '18px Arial'; CONFIG.ctx.fillStyle = '#ccc'; let dignityText = ''; if(ASTRO_DATA.rulers[i]) dignityText += '♦' + ASTRO_DATA.rulers[i]; if(ASTRO_DATA.exaltations[i]) dignityText += ' ▲' + ASTRO_DATA.exaltations[i]; if(dignityText) {CONFIG.ctx.fillText(dignityText, x, y + yOffset); yOffset += 15;}} const checks = [[document.getElementById('showQualities').checked, ASTRO_DATA.qualities[i]], [document.getElementById('showElements').checked, ASTRO_DATA.elements[i]], [document.getElementById('showSeason').checked, ASTRO_DATA.seasons[i]], [document.getElementById('showSolarIngress').checked, ASTRO_DATA.solarIngress[i]], [document.getElementById('showFigureSigns').checked, ASTRO_DATA.figureSigns[i]], [document.getElementById('showFertileBarren').checked, ASTRO_DATA.fertileBarren[i]], [document.getElementById('showSignTemps').checked, ASTRO_DATA.signTemps[i]], [document.getElementById('showSignGenders').checked, ASTRO_DATA.signGenders[i]]]; const infoText = checks.filter(c => c[0]).map(c => c[1]).join('|'); if(infoText) {CONFIG.ctx.font = '12px Arial'; CONFIG.ctx.fillStyle = '#ccc'; CONFIG.ctx.fillText(infoText, x, y + yOffset); yOffset += 12;}}
            
            if(document.getElementById('showDecans').checked) {for(let i = 0; i < 12; i++) {for(let d = 0; d < 3; d++) {const decanAngle = Utils.degToRad(180 - (i * 30 + d * 10) - state.zodiacOffset); CONFIG.ctx.strokeStyle = '#666'; CONFIG.ctx.lineWidth = 1; CONFIG.ctx.beginPath(); CONFIG.ctx.moveTo(CONFIG.center + Math.cos(decanAngle) * CONFIG.radii.inner, CONFIG.center + Math.sin(decanAngle) * CONFIG.radii.inner); CONFIG.ctx.lineTo(CONFIG.center + Math.cos(decanAngle) * CONFIG.radii.decan, CONFIG.center + Math.sin(decanAngle) * CONFIG.radii.decan); CONFIG.ctx.stroke(); const decanMidAngle = Utils.degToRad(180 - (i * 30 + d * 10 + 5) - state.zodiacOffset), decanRadius = (CONFIG.radii.inner + CONFIG.radii.decan) / 2, dx = CONFIG.center + Math.cos(decanMidAngle) * decanRadius, dy = CONFIG.center + Math.sin(decanMidAngle) * decanRadius; CONFIG.ctx.fillStyle = '#87CEEB'; CONFIG.ctx.font = 'bold 20px Arial'; CONFIG.ctx.textAlign = 'center'; CONFIG.ctx.textBaseline = 'middle'; CONFIG.ctx.fillText(ASTRO_DATA.decans[i][d], dx, dy);}}}
            
            for(let i = 0; i < 12; i++) {const angle = Utils.degToRad(180 - (i * 30)); CONFIG.ctx.strokeStyle = state.mode === 'houses' ? '#FF6666' : '#444'; CONFIG.ctx.lineWidth = state.mode === 'houses' ? 2 : 1; CONFIG.ctx.beginPath(); CONFIG.ctx.moveTo(CONFIG.center + Math.cos(angle) * CONFIG.radii.aspect, CONFIG.center + Math.sin(angle) * CONFIG.radii.aspect); CONFIG.ctx.lineTo(CONFIG.center + Math.cos(angle) * CONFIG.radii.inner, CONFIG.center + Math.sin(angle) * CONFIG.radii.inner); CONFIG.ctx.stroke(); const houseR = (CONFIG.radii.aspect + CONFIG.radii.inner) / 2, midAngle = Utils.degToRad(180 - (i * 30 + 15)), x = CONFIG.center + Math.cos(midAngle) * houseR, y = CONFIG.center + Math.sin(midAngle) * houseR; CONFIG.ctx.fillStyle = state.mode === 'houses' ? '#FF6666' : '#888'; CONFIG.ctx.font = 'bold 18px Arial'; CONFIG.ctx.textAlign = 'center'; CONFIG.ctx.textBaseline = 'middle'; CONFIG.ctx.fillText((i + 1).toString(), x, y); let yOffset = 15; if(document.getElementById('showHouseSect').checked) {CONFIG.ctx.font = '14px Arial'; CONFIG.ctx.fillStyle = '#ff9999'; CONFIG.ctx.fillText(ASTRO_DATA.houseSect[i], x, y + yOffset); yOffset += 12;} if(document.getElementById('showHouseTypes').checked) {CONFIG.ctx.font = '14px Arial'; CONFIG.ctx.fillStyle = '#90ee90'; CONFIG.ctx.fillText(ASTRO_DATA.houseTypes[i], x, y + yOffset); yOffset += 12;} if(document.getElementById('showhouseJoy').checked) {CONFIG.ctx.font = '14px Arial'; CONFIG.ctx.fillStyle = '#eeee90'; CONFIG.ctx.fillText(ASTRO_DATA.houseJoy[i], x, y + yOffset); yOffset += 12;} if(document.getElementById('showDirections').checked) {CONFIG.ctx.font = '12px Arial'; CONFIG.ctx.fillStyle = '#87ceeb'; CONFIG.ctx.fillText(ASTRO_DATA.houseDirections[i], x, y + yOffset);}}
            
            planets.forEach((planet, index) => {const pos = Utils.getPlanetPos(planet.angle), isSelected = state.selectedPlanet === index, signIndex = Utils.getSignFromAngle(planet.angle), dignity = Utils.getDignity(planet.symbol, signIndex); if(document.getElementById('showDignities').checked) {CONFIG.ctx.strokeStyle = Utils.getDignityColor(dignity); CONFIG.ctx.lineWidth = 4;} else {CONFIG.ctx.strokeStyle = state.mode === 'planets' ? (isSelected ? '#FF6666' : '#FFF') : '#666'; CONFIG.ctx.lineWidth = state.mode === 'planets' ? (isSelected ? 4 : 3) : 2;} CONFIG.ctx.fillStyle = planet.color; CONFIG.ctx.beginPath(); CONFIG.ctx.arc(pos.x, pos.y, 18, 0, Math.PI * 2); CONFIG.ctx.fill(); CONFIG.ctx.stroke(); CONFIG.ctx.fillStyle = '#000'; CONFIG.ctx.font = 'bold 24px Arial'; CONFIG.ctx.textAlign = 'center'; CONFIG.ctx.textBaseline = 'middle'; CONFIG.ctx.fillText(planet.symbol, pos.x, pos.y); if(state.mode === 'planets') {CONFIG.ctx.fillStyle = '#FF4444'; CONFIG.ctx.font = 'bold 16px Arial'; CONFIG.ctx.fillText('×', pos.x + 15, pos.y - 15);} let yOffset = 25; if(document.getElementById('showDignities').checked) {CONFIG.ctx.fillStyle = Utils.getDignityColor(dignity); CONFIG.ctx.font = 'bold 12px Arial'; CONFIG.ctx.textAlign = 'center'; CONFIG.ctx.fillText(dignity, pos.x, pos.y + yOffset); yOffset += 15;} if(document.getElementById('showInfo').checked) {const houseIndex = Utils.getHouseFromAngle(planet.angle), degree = Math.floor((planet.angle - state.zodiacOffset + 360) % 30); CONFIG.ctx.fillStyle = '#FFF'; CONFIG.ctx.font = '12px Arial'; const info = state.mode === 'houses' ? `H${houseIndex + 1}` : `${ASTRO_DATA.signNames[signIndex]} ${degree}°`; CONFIG.ctx.fillText(info, pos.x, pos.y + yOffset); yOffset += 12;} const pChecks = [[document.getElementById('showPlanetTemps').checked, ASTRO_DATA.planetTemps[planet.symbol]], [document.getElementById('showPlanetSect').checked, ASTRO_DATA.planetSect[planet.symbol]], [document.getElementById('showBeneficMaleficPlanets').checked, ASTRO_DATA.beneficMaleficPlanets[planet.symbol]], [document.getElementById('showPlanetGender').checked, ASTRO_DATA.planetGender[planet.symbol]]]; const pText = pChecks.filter(c => c[0] && c[1]).map(c => c[1]).join('|'); if(pText) {CONFIG.ctx.fillStyle = '#CCC'; CONFIG.ctx.font = '11px Arial'; CONFIG.ctx.fillText(pText, pos.x, pos.y + yOffset);}});
            
            DrawingSystem.drawPaths(); CONFIG.ctx.fillStyle = '#1a1a1a'; CONFIG.ctx.beginPath(); CONFIG.ctx.arc(CONFIG.center, CONFIG.center, CONFIG.radii.aspect, 0, Math.PI * 2); CONFIG.ctx.fill(); CONFIG.ctx.strokeStyle = '#444'; CONFIG.ctx.lineWidth = 1; CONFIG.ctx.beginPath(); CONFIG.ctx.arc(CONFIG.center, CONFIG.center, CONFIG.radii.aspect, 0, Math.PI * 2); CONFIG.ctx.stroke(); DrawingSystem.drawPaths();
        }
    };

    // User Interface Controller
    const UI = {
        showKeywords: (type, name) => {const panel = document.getElementById('keywordsPanel'), keywordList = keywords[type + 's']?.[name]; if(keywordList) panel.innerHTML = `<h3>${name}</h3><ul>${keywordList.map(k => `<li>• ${k}</li>`).join('')}</ul>`;},
        setMode: newMode => {state.mode = newMode; state.selectedSign = null; state.selectedPlanet = null; document.querySelectorAll('button').forEach(btn => btn.classList.remove('active')); document.getElementById(newMode + 'Btn').classList.add('active'); document.getElementById('planetSelect').style.display = newMode === 'planets' ? 'inline' : 'none'; document.getElementById('drawControls').style.display = newMode === 'draw' ? 'block' : 'none'; const tool = document.getElementById('drawTool')?.value || 'pencil'; CONFIG.canvas.style.cursor = newMode === 'draw' ? (tool === 'eraser' ? 'none' : 'crosshair') : 'default'; if(newMode !== 'draw') document.getElementById('eraserIndicator').style.display = 'none'; UI.updateInfo(); Renderer.drawChart();},
        updateInfo: text => {const info = document.getElementById('info'); if(text) {info.innerHTML = text; return;} const messages = {zodiac: 'Click sign to select, then use arrows or drag ring to rotate • Click for keywords', houses: 'Drag planets to see houses • Click for keywords', planets: 'Click planet to select, then use arrows or drag • Click × to delete', draw: 'Draw on chart • Use pencil/line/eraser tools'}; info.textContent = messages[state.mode];},
        clearDrawing: () => {Object.assign(state, {drawingPaths: [], currentPath: [], lineStartPoint: null, isDrawing: false, isErasing: false}); document.getElementById('eraserIndicator').style.display = 'none'; Renderer.drawChart();},
        resetChart: () => {Object.assign(state, {zodiacOffset: 0, ascendantOffset: 0, selectedSign: null, selectedPlanet: null, drawingPaths: [], currentPath: [], lineStartPoint: null, isDrawing: false, isErasing: false, isDragging: false, dragTarget: null}); document.getElementById('eraserIndicator').style.display = 'none'; planets = [{symbol:'☉',name:'Sun',angle:120,color:'#FFD700'},{symbol:'☽',name:'Moon',angle:90,color:'#C0C0C0'},{symbol:'♂',name:'Mars',angle:0,color:'#FF4500'},{symbol:'♀',name:'Venus',angle:30,color:'#32CD32'},{symbol:'☿',name:'Mercury',angle:60,color:'#FFA500'},{symbol:'♃',name:'Jupiter',angle:240,color:'#4169E1'},{symbol:'♄',name:'Saturn',angle:270,color:'#8B4513'}]; UI.setMode('zodiac'); UI.updateInfo('Chart reset'); Renderer.drawChart();}
    };

    // Event Handler System
    const Events = {
        handleClick: e => {if(state.mode === 'draw') return; const pos = Utils.getMousePos(e), planetData = HitDetection.getPlanetAt(pos.x, pos.y), signIndex = HitDetection.getSignAt(pos.x, pos.y), houseIndex = HitDetection.getHouseAt(pos.x, pos.y); if(planetData && !state.isDragging) {if(state.mode === 'planets') {state.selectedPlanet = planetData.index; Renderer.drawChart();} UI.showKeywords('planet', planetData.planet.name);} else if(signIndex !== null && !state.isDragging) {if(state.mode === 'zodiac') {state.selectedSign = signIndex; Renderer.drawChart();} UI.showKeywords('sign', ASTRO_DATA.signNames[signIndex]);} else if(houseIndex !== null && !state.isDragging) {const houseNum = houseIndex + 1, ordinal = houseNum === 1 ? 'st' : houseNum === 2 ? 'nd' : houseNum === 3 ? 'rd' : 'th'; UI.showKeywords('house', houseNum + ordinal);}},
        handleMouseDown: e => {const pos = Utils.getMousePos(e); if(state.mode === 'draw') {e.preventDefault(); const tool = document.getElementById('drawTool').value, color = document.getElementById('drawColor').value, size = parseInt(document.getElementById('drawSize').value); if(tool === 'eraser') {state.isErasing = true; DrawingSystem.eraseAtPoint(pos.x, pos.y, size * 2); Renderer.drawChart();} else if(tool === 'line') {if(!state.lineStartPoint) state.lineStartPoint = {x: pos.x, y: pos.y, color, size, type: 'line'}; else {state.drawingPaths.push([state.lineStartPoint, {x: pos.x, y: pos.y, color, size, type: 'line'}]); state.lineStartPoint = null; Renderer.drawChart();}} else {state.isDrawing = true; state.currentPath = [{x: pos.x, y: pos.y, color, size, type: 'pencil'}];} return;} const angleControl = HitDetection.getAngleControlAt(pos.x, pos.y); if(angleControl) {e.preventDefault(); state.isDragging = true; state.dragTarget = 'angle-control'; state.dragAngleControl = angleControl; return;} const planetData = HitDetection.getPlanetAt(pos.x, pos.y); if(planetData) {e.preventDefault(); if(state.mode === 'planets' && pos.x > Utils.getPlanetPos(planetData.planet.angle).x + 8 && pos.y < Utils.getPlanetPos(planetData.planet.angle).y - 8) {planets.splice(planetData.index, 1); if(state.selectedPlanet === planetData.index) state.selectedPlanet = null; else if(state.selectedPlanet > planetData.index) state.selectedPlanet--; Renderer.drawChart(); UI.updateInfo('Planet deleted'); return;} state.isDragging = true; state.dragTarget = planetData.planet; if(state.mode === 'planets') state.selectedPlanet = planetData.index;} else if(state.mode === 'zodiac' && HitDetection.isInZodiacRing(pos.x, pos.y)) {e.preventDefault(); state.isDragging = true; state.dragTarget = 'zodiac'; state.lastZodiacAngle = Utils.getAngleFromPos(pos.x, pos.y);}},
        handleMouseMove: e => {const pos = Utils.getMousePos(e); if(state.mode === 'draw') {const tool = document.getElementById('drawTool').value, color = document.getElementById('drawColor').value, size = parseInt(document.getElementById('drawSize').value); DrawingSystem.updateEraserIndicator(pos.x, pos.y); if(tool === 'eraser' && state.isErasing) {DrawingSystem.eraseAtPoint(pos.x, pos.y, size * 2); Renderer.drawChart();} else if(tool === 'pencil' && state.isDrawing && state.currentPath.length > 0) {state.currentPath.push({x: pos.x, y: pos.y, color, size, type: 'pencil'}); if(state.currentPath.length > 1) {CONFIG.ctx.strokeStyle = color; CONFIG.ctx.lineWidth = size; CONFIG.ctx.lineCap = 'round'; CONFIG.ctx.lineJoin = 'round'; CONFIG.ctx.beginPath(); const prev = state.currentPath[state.currentPath.length - 2], curr = state.currentPath[state.currentPath.length - 1]; CONFIG.ctx.moveTo(prev.x, prev.y); CONFIG.ctx.lineTo(curr.x, curr.y); CONFIG.ctx.stroke();}} else if(tool === 'line' && state.lineStartPoint) {Renderer.drawChart(); CONFIG.ctx.strokeStyle = color; CONFIG.ctx.lineWidth = size; CONFIG.ctx.lineCap = 'round'; CONFIG.ctx.setLineDash([5, 5]); CONFIG.ctx.beginPath(); CONFIG.ctx.moveTo(state.lineStartPoint.x, state.lineStartPoint.y); CONFIG.ctx.lineTo(pos.x, pos.y); CONFIG.ctx.stroke(); CONFIG.ctx.setLineDash([]);} return;} if(!state.isDragging || !state.dragTarget) return; if(state.dragTarget === 'zodiac') {const currentAngle = Utils.getAngleFromPos(pos.x, pos.y), deltaAngle = currentAngle - state.lastZodiacAngle; state.zodiacOffset = (state.zodiacOffset + deltaAngle) % 360; if(state.zodiacOffset < 0) state.zodiacOffset += 360; state.lastZodiacAngle = currentAngle; Renderer.drawChart();} else if(state.dragTarget === 'angle-control') {state.ascendantOffset = Utils.getAngleFromPos(pos.x, pos.y); Renderer.drawChart();} else {state.dragTarget.angle = Utils.getAngleFromPos(pos.x, pos.y); const signIndex = Utils.getSignFromAngle(state.dragTarget.angle), houseIndex = Utils.getHouseFromAngle(state.dragTarget.angle), degree = Math.floor((state.dragTarget.angle - state.zodiacOffset + 360) % 30); if(state.mode === 'zodiac') {const dignity = Utils.getDignity(state.dragTarget.symbol, signIndex), color = Utils.getDignityColor(dignity); UI.updateInfo(`<strong>${state.dragTarget.name}</strong>: ${ASTRO_DATA.signNames[signIndex]} ${degree}° - <span style="color: ${color}">${dignity}</span>`);} else if(state.mode === 'houses') UI.updateInfo(`<strong>${state.dragTarget.name}</strong>: ${ASTRO_DATA.houseNames[houseIndex]}`); Renderer.drawChart();}},
        handleMouseUp: () => {if(state.mode === 'draw') {if(state.isDrawing && state.currentPath.length > 0) {state.drawingPaths.push([...state.currentPath]); state.currentPath = [];} state.isDrawing = false; state.isErasing = false;} state.isDragging = false; state.dragTarget = null; state.dragAngleControl = null; UI.updateInfo();},
        handleKeyDown: e => {if(e.key === 'ArrowLeft' || e.key === 'ArrowRight') {const increment = e.key === 'ArrowLeft' ? 1 : -1; if(state.mode === 'zodiac' && state.selectedSign !== null) {state.zodiacOffset = (state.zodiacOffset + increment + 360) % 360; Renderer.drawChart(); e.preventDefault();} else if(state.mode === 'planets' && state.selectedPlanet !== null) {planets[state.selectedPlanet].angle = (planets[state.selectedPlanet].angle + increment + 360) % 360; Renderer.drawChart(); e.preventDefault();} else if(document.getElementById('showAngles').checked) {state.ascendantOffset = (state.ascendantOffset + increment + 360) % 360; Renderer.drawChart(); e.preventDefault();}}}
    };

    // Initialization & Event Binding
    CONFIG.canvas.addEventListener('click', Events.handleClick);
    CONFIG.canvas.addEventListener('mousedown', Events.handleMouseDown);
    CONFIG.canvas.addEventListener('mousemove', Events.handleMouseMove);
    CONFIG.canvas.addEventListener('mouseup', Events.handleMouseUp);
    CONFIG.canvas.addEventListener('mouseleave', () => document.getElementById('eraserIndicator').style.display = 'none');
    document.addEventListener('keydown', Events.handleKeyDown);

    document.getElementById('planetSelect').addEventListener('change', e => {if(!e.target.value) return; const planetData = {symbols: {'☉':'Sun','☽':'Moon','☿':'Mercury','♀':'Venus','♂':'Mars','♃':'Jupiter','♄':'Saturn','☊':'North Node','☋':'South Node','⦻':'Part of Fortune'}, colors: {'☉':'#FFD700','☽':'#C0C0C0','☿':'#FFA500','♀':'#32CD32','♂':'#FF4500','♃':'#4169E1','♄':'#8B4513','☊':'#FFE4B5','☋':'#DDA0DD','⦻':'#20B2AA'}}; planets.push({symbol: e.target.value, name: planetData.symbols[e.target.value], angle: Math.random() * 360, color: planetData.colors[e.target.value]}); e.target.value = ''; Renderer.drawChart();});
    document.getElementById('drawTool').addEventListener('change', e => {const tool = e.target.value; if(state.mode === 'draw') {CONFIG.canvas.style.cursor = tool === 'eraser' ? 'none' : 'crosshair'; if(tool !== 'eraser') document.getElementById('eraserIndicator').style.display = 'none';}});
    document.getElementById('drawSize').addEventListener('input', e => document.getElementById('sizeValue').textContent = e.target.value + 'px');

    ['showInfo','showDignities','showQualities','showElements','showSeason','showFigureSigns','showSolarIngress','showFertileBarren','showSignTemps','showSignGenders','showAngles','showPlanetTemps','showPlanetSect','showBeneficMaleficPlanets','showPlanetGender','showHouseSect','showHouseTypes','showhouseJoy','showEgyptianBounds','showPtolemyBounds','showChaldeanBounds','showDecans','showDirections'].forEach(id => document.getElementById(id).addEventListener('change', Renderer.drawChart));

    // Public API
    return {setMode: UI.setMode, updateInfo: UI.updateInfo, clearDrawing: UI.clearDrawing, resetChart: UI.resetChart, drawChart: Renderer.drawChart, init: () => {Renderer.drawChart(); UI.updateInfo();}};
})();

// Global function bindings for HTML compatibility
window.setMode = AstrologyChart.setMode;
window.clearDrawing = AstrologyChart.clearDrawing;
window.resetChart = AstrologyChart.resetChart;
window.addEventListener('load', AstrologyChart.init);
</script>
</body>
</html>
